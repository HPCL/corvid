---
title: "Figures for The potential effectiveness of non-pharmaceutical interventions against SARS-CoV-2 in the United States, a modeling study"
author: "Dennis Chao"
header-includes:
- \usepackage{fancyhdr}
- \pagestyle{fancy}
- \fancyhead[RO]{\today}
output:
  pdf_document: 
    fig_caption: yes
    fig_width: 6.5
    fig_height: 5.5
---

```{r initialize, echo=FALSE}
library(knitr)
library(RColorBrewer)
palr0 <- c("black", "red", "blue", "black", "red", "blue")
names(palr0) <- c("2.5", "3.0", "2.0", "2.5","3","2")
```

This pdf is generated from an R Markdown script. The Markdown generates figures and other results.


# Results

```{r load-seattle, echo=FALSE}
tractlocs.seattle <- read.csv("../corviddata/seattle-tracts.dat", header=FALSE, col.names=c("fipsstate", "fipscounty", "fipstract", "population", "latitude", "longitude"))
tracts.seattle <- read.csv("results/Tracts-seattle26", header=TRUE)
tracts.seattle$pop <- rowSums(tracts.seattle[5:9])
popsize.seattle <- sum(tracts.seattle$pop)
tractlocs.seattle$TractID <- tracts.seattle$TractID[sapply(1:nrow(tractlocs.seattle), function(i) {which(tracts.seattle$FIPSstate==tractlocs.seattle$fipsstate[i] &
                tracts.seattle$FIPScounty==tractlocs.seattle$fipscounty[i] &
                tracts.seattle$FIPStract==tractlocs.seattle$fipstract[i])})]

wf.seattle <- read.csv("../corviddata/seattle-wf.dat", header=FALSE, sep=" ", col.names=c("source.fipsstate", "source.fipscounty", "source.fipstract", "dest.fipsstate", "dest.fipscounty", "dest.fipstract", "flow"))

# load the "no intervention" outputs
symptomatic.seattle <- list()
csymptomatic.seattle <- list()
newlysymptomatic.seattle <- list()
individuals.seattle <- list()
for (r0 in c(2.0,2.6)) {
  temp <- readLines(paste("results/Summary-seattle",r0*10,"",sep=""))
  symptomatic.seattle[[as.character(r0)]] <- as.numeric(strsplit(gsub("^.*: ","",temp[grep("Number symptomatic", temp)]),",")[[1]])
  csymptomatic.seattle[[as.character(r0)]] <- as.numeric(strsplit(gsub("^.*: ","",temp[grep("Cumulative symptomatic", temp)]),",")[[1]])
  newlysymptomatic.seattle[[as.character(r0)]] <- c(symptomatic.seattle[[as.character(r0)]][1], diff(csymptomatic.seattle[[as.character(r0)]]))
  individuals.seattle[[as.character(r0)]] <- read.csv(paste("results/Individuals-seattle",r0*10,sep=""), header=TRUE)
  individuals.seattle[[as.character(r0)]]$SOURCETYPE <- ifelse(individuals.seattle[[as.character(r0)]]$sourcetype==0, NA,
                   ifelse(individuals.seattle[[as.character(r0)]]$sourcetype==1, "daytime.family",
                   ifelse(individuals.seattle[[as.character(r0)]]$sourcetype==2, "daytime.comm",
                   ifelse(individuals.seattle[[as.character(r0)]]$sourcetype==3, "daytime.nh",
                   ifelse(individuals.seattle[[as.character(r0)]]$sourcetype==4, "daytime.school",
                   ifelse(individuals.seattle[[as.character(r0)]]$sourcetype==5, "daytime.work",
                   ifelse(individuals.seattle[[as.character(r0)]]$sourcetype==10, "nighttime.family",
                   ifelse(individuals.seattle[[as.character(r0)]]$sourcetype==11, "nighttime.comm",
                   ifelse(individuals.seattle[[as.character(r0)]]$sourcetype==12, "nighttime.nh",
                   ifelse(individuals.seattle[[as.character(r0)]]$sourcetype==13, "nighttime.hhcluster",
                   ifelse(individuals.seattle[[as.character(r0)]]$sourcetype==20, "seeded",
		   ifelse(individuals.seattle[[as.character(r0)]]$sourcetype==21, "airport", "error"))))))))))))
  individuals.seattle[[as.character(r0)]]$generationtime <- (individuals.seattle[[as.character(r0)]]$infectedtime-individuals.seattle[[as.character(r0)]]$infectedtime[match(individuals.seattle[[as.character(r0)]]$sourceid,individuals.seattle[[as.character(r0)]]$id)])/2 # how many days ago was the infecter infected?
  individuals.seattle[[as.character(r0)]]$generationtime[individuals.seattle[[as.character(r0)]]$infectedtime<=0] <- NA # remove people never infected or infected on day 0
}
```

We ran simulations in a synthetic population that represents a large American city with a population of `r as.integer(sum(tracts.seattle$pop))`.
The synthetic population resides in `r nrow(tracts.seattle)` census tracts.
Tracts have `r min(tracts.seattle$pop)` to `r as.integer(max(tracts.seattle$pop))` people living in them, and `r min(tracts.seattle$workers)` to `r as.integer(max(tracts.seattle$workers))` people working in them.
In an unmitigated outbreak starting with five infected people, `r round(100*csymptomatic.seattle[["2.6"]][length(csymptomatic.seattle[["2.6"]])]/popsize.seattle,2)`% of the population become symptomatic when R0=2.6

```{r cases-seattle, fig.width=7, fig.height=3.25, fig.cap="Symptomatic people over time in a metropolitan area. On the left, the number of people who become symptomatic each day for R0=2.6 and R0=2.0. On the right, the log$_2$ cumulative cases are plotted and two linear regression fits to estimate doubling time for R0=2.6.", echo=FALSE}
par(mfrow=c(1,2),
    mar=c(3.5,3.5,1,1), #bottom, left, top, and right.
    mgp=c(2.0, 0.6, 0))
days <- 1:length(newlysymptomatic.seattle[["2.6"]])
plot(x=days, y=newlysymptomatic.seattle[["2.6"]], xlab="days since introduction", ylab="newly symptomatic per day", type="l", lwd=2)
lines(x=days, y=newlysymptomatic.seattle[["2"]], lwd=2, col="red")
legend("topleft", legend=c("R0=2.6", "R0=2.0"), fill=c("black", "red"), inset=0.01, cex=0.8)
startday <- 25
endday <- 45
startday2 <- 60
endday2 <- 90
plot(x=days, y=log(csymptomatic.seattle[["2.6"]],2), xlab="days since introduction", ylab="log2(cumulative symptomatic)", col=ifelse(days>=startday & days<endday,"black",ifelse(days>=startday2 & days<endday2,"blue","gray")), cex=0.5)
lmf = summary(lm(log(csymptomatic.seattle[["2.6"]][startday:endday],2) ~ days[startday:endday], na.action = na.omit))
abline(lmf$coefficients[1],lmf$coefficients[2], col="black")
text(35,5,substitute(log2(cumulative) == a * day + b, list(a=round(lmf$coefficients[2],digits=4), b=round(lmf$coefficients[1],digits=4))), pos=4, cex=0.65, col="black")
#points(x=days, y=log(csymptomatic.seattle[["2.6"]],2), col=ifelse(days<startday2 | days>endday2,"pink","red"), pch=2, cex=0.5)
lmf2 = summary(lm(log(csymptomatic.seattle[["2.6"]][startday2:endday2],2) ~ days[startday2:endday2], na.action = na.omit))
abline(lmf2$coefficients[1],lmf2$coefficients[2], col="blue")
text(35,3,substitute(log2(cumulative) == a * day + b, list(a=round(lmf2$coefficients[2],digits=4), b=round(lmf2$coefficients[1],digits=4))), pos=4, cex=0.65, col="blue")
#legend("bottomright", legend=c("R0=2.6", "R0=2.0"), fill=c("black", "red"), inset=0.01, cex=0.8)
```

```{r seattle-generationtime, fig.width=7, fig.height=3.25, fig.cap="Generation time and incubation period distribution. Results from one epidemic simulation with R0=2.6. On the left, the distribution of generation times. On the right, incubation period distribution.", echo=FALSE}
par(mfrow=c(1,2),
    mar=c(3.5,3.5,1,1), #bottom, left, top, and right.
    mgp=c(2.0, 0.6, 0))
hist(individuals.seattle[[as.character(r0)]]$generationtime, breaks=seq(0,max(individuals.seattle[[as.character(r0)]]$generationtime,na.rm=TRUE)+0.5,1), xlab="generation time, days", main="generation time distribution")

hist(individuals.seattle[[as.character(r0)]]$incubationdays[individuals.seattle[[as.character(r0)]]$incubationdays>0], breaks=seq(0,max(individuals.seattle[[as.character(r0)]]$incubationdays,na.rm=TRUE)+0.5,1), xlab="incubation period, days", main="incubation period distribution")
# incubation of 0 is asymptomatic in the model
```

The doubling time was initially `r round(1/lmf$coefficients[2],2)` days
then slowed to `r round(1/lmf2$coefficients[2],2)` days.
The average generation time was `r round(mean(individuals.seattle[[as.character(r0)]]$generationtime,na.rm=TRUE),2)` days, median of `r median(individuals.seattle[[as.character(r0)]]$generationtime,na.rm=TRUE)` days. The maximum infectious period allowed by the model was 21 days.


```{r seattle-r0test, fig.width=5.5, fig.height=3.75, fig.cap="Number of people an individual infects in the Seattle population model. R0=2.6", echo=FALSE}
# kable(100*table(individuals.seattle[[as.character(r0)]]$SOURCETYPE)/sum(!is.na(individuals.seattle[[as.character(r0)]]$sourcetype) & individuals.seattle[[as.character(r0)]]$sourcetype<20), digits=2, caption="source of infections R0=2.6, %")
#kable(table(table(individuals.seattle[[as.character(r0)]]$sourceid)), caption="number of infections caused by an individual")
temp <- table(table(individuals.seattle[[as.character(r0)]]$sourceid))
plot(temp, ylim=c(0,1.05*max(temp)), xlab="number of people an individual infects", ylab="frequency", pch=4, cex=0.5, col="red", lwd=2)
text(x=as.numeric(names(temp)), y=temp, lab=temp, col="blue", adj=c(0.5,-0.5), cex=0.6)
```

\clearpage

### Where do infections occur?

```{r seattle-cumulativebysource, fig.width=7, fig.height=3.25, fig.cap="Settings of infections in the Seattle model (R0=2.6). On the left, cumulative infections in the Seattle population model by source of infection. On the right, cumulative proportion of infections by source. The sources plotted on the right do not add up to one - the remainder of infections come from the general community.", echo=FALSE}
par(mfrow=c(1,2),
    mar=c(3.5,3.5,1,3), #bottom, left, top, and right.
    mgp=c(2.0, 0.6, 0))
timesteps <- 0:max(individuals.seattle[[as.character(r0)]]$infectedtime)
plot(x=timesteps/2, y=sapply(timesteps, function(t) {sum(individuals.seattle[[as.character(r0)]]$infectedtime>0 & individuals.seattle[[as.character(r0)]]$infectedtime<=t)}), xlab="simulation day", ylab="cumulative infections", type="l", cex.axis=0.8)
axis(4, at=seq(0,1,0.25)*nrow(individuals.seattle[[as.character(r0)]]), lab=paste(100*seq(0,1,0.25),"%",sep=""), cex.axis=0.85, las=2)
polygon(x=c(timesteps/2,max(timesteps)/2,0), y=c(sapply(timesteps, function(t) {sum(individuals.seattle[[as.character(r0)]]$infectedtime>0 & individuals.seattle[[as.character(r0)]]$SOURCETYPE %in% c("daytime.family","nighttime.family") & individuals.seattle[[as.character(r0)]]$infectedtime<=t)}),0,0), col="salmon", border="darkred")
polygon(x=c(timesteps/2,rev(timesteps/2)), y=c(sapply(timesteps, function(t) {sum(individuals.seattle[[as.character(r0)]]$infectedtime>0 & individuals.seattle[[as.character(r0)]]$SOURCETYPE %in% c("daytime.family","nighttime.family") & individuals.seattle[[as.character(r0)]]$infectedtime<=t)}),
  sapply(rev(timesteps), function(t) {sum(individuals.seattle[[as.character(r0)]]$infectedtime>0 & individuals.seattle[[as.character(r0)]]$SOURCETYPE %in% c("daytime.family","nighttime.family","daytime.work") & individuals.seattle[[as.character(r0)]]$infectedtime<=t)})),
 col="lightblue", border="darkblue")
polygon(x=c(timesteps/2,rev(timesteps/2)), y=c(sapply(timesteps, function(t) {sum(individuals.seattle[[as.character(r0)]]$infectedtime>0 & individuals.seattle[[as.character(r0)]]$SOURCETYPE %in% c("daytime.family","nighttime.family","daytime.work") & individuals.seattle[[as.character(r0)]]$infectedtime<=t)}),
  sapply(rev(timesteps), function(t) {sum(individuals.seattle[[as.character(r0)]]$infectedtime>0 & individuals.seattle[[as.character(r0)]]$SOURCETYPE %in% c("daytime.family","nighttime.family","daytime.work","daytime.school") & individuals.seattle[[as.character(r0)]]$infectedtime<=t)})),
 col="orchid", border="purple")
legend("topleft", legend=c("family","workplace","school","other"), fill=c("salmon","lightblue","orchid","white"), bg="white", cex=0.8, inset=0.01)

plot(x=NA, y=NA, xlim=c(0,max(timesteps)/2), ylim=c(0,1), xlab="simulation day", ylab="cumulative proportion by source", cex.lab=0.95, cex.axis=0.8, type="l")
tot <- sapply(timesteps, function(t) {sum(individuals.seattle[[as.character(r0)]]$infectedtime>0 & individuals.seattle[[as.character(r0)]]$infectedtime<=t)})
lines(x=timesteps/2, y=sapply(timesteps, function(t) {sum(individuals.seattle[[as.character(r0)]]$infectedtime>0 & individuals.seattle[[as.character(r0)]]$SOURCETYPE %in% c("daytime.family","nighttime.family") & individuals.seattle[[as.character(r0)]]$infectedtime<=t)})/tot, col="red", lwd=1.5)
lines(x=timesteps/2, y=sapply(timesteps, function(t) {sum(individuals.seattle[[as.character(r0)]]$infectedtime>0 & individuals.seattle[[as.character(r0)]]$SOURCETYPE %in% c("daytime.work") & individuals.seattle[[as.character(r0)]]$infectedtime<=t)})/tot, col="blue", lwd=1.5)
lines(x=timesteps/2, y=sapply(timesteps, function(t) {sum(individuals.seattle[[as.character(r0)]]$infectedtime>0 & individuals.seattle[[as.character(r0)]]$SOURCETYPE %in% c("daytime.school") & individuals.seattle[[as.character(r0)]]$infectedtime<=t)})/tot, col="purple", lwd=1.5)
legend("topright", legend=c("family","workplace","school"), fill=c("red","blue","purple"), inset=0.01)

temp <- data.frame(setting=c("school","work","home","community/neighbors","total"))
r0 <- 2.6
temp$infected26 <- c(sum(individuals.seattle[[as.character(r0)]]$SOURCETYPE=="daytime.school",na.rm=TRUE),
           sum(individuals.seattle[[as.character(r0)]]$SOURCETYPE=="daytime.work",na.rm=TRUE),
	   sum(individuals.seattle[[as.character(r0)]]$SOURCETYPE %in% c("daytime.family","nighttime.family"),na.rm=TRUE),
	   sum(individuals.seattle[[as.character(r0)]]$SOURCETYPE %in% c("daytime.comm","daytime.nh","nighttime.comm","nighttime.nh","nighttime.hhcluster"),na.rm=TRUE),
	   sum(!is.na(individuals.seattle[[as.character(r0)]]$SOURCETYPE) & individuals.seattle[[as.character(r0)]]$SOURCETYPE!="seeded"))
r0 <- 2.0
temp$infected20 <- c(sum(individuals.seattle[[as.character(r0)]]$SOURCETYPE=="daytime.school",na.rm=TRUE),
           sum(individuals.seattle[[as.character(r0)]]$SOURCETYPE=="daytime.work",na.rm=TRUE),
	   sum(individuals.seattle[[as.character(r0)]]$SOURCETYPE %in% c("daytime.family","nighttime.family"),na.rm=TRUE),
	   sum(individuals.seattle[[as.character(r0)]]$SOURCETYPE %in% c("daytime.comm","daytime.nh","nighttime.comm","nighttime.nh","nighttime.hhcluster"),na.rm=TRUE),
	   sum(!is.na(individuals.seattle[[as.character(r0)]]$SOURCETYPE) & individuals.seattle[[as.character(r0)]]$SOURCETYPE!="seeded"))
temp$infected26 <- 100*temp$infected26/temp$infected26[nrow(temp)]
temp$infected20 <- 100*temp$infected20/temp$infected20[nrow(temp)]
kable(temp, digits=1, caption="Proportion of infections by settings for R0=2.6 and R0=2.0, %")
```

\clearpage
```{r seattle-household-secondary, fig.width=7, fig.height=3.25, fig.cap="household attack rates.", echo=FALSE}
# secondary household attack rates
# matrix for child/adult -> child/adult transmission within a family
R0datahh <- read.csv("../hhattackrateruns/r0summary-hh.csv")
sa <- matrix(data=0,nrow=2,ncol=2, dimnames=list(c("child", "adult"),c("child", "adult")))
sahh <- matrix(data=0,nrow=2,ncol=2, dimnames=list(c("child", "adult"),c("child", "adult")))
sahh[1,1] <- sum(R0datahh$thhage0[R0datahh$age<=1]+R0datahh$thhage1[R0datahh$age<=1])
sahh[1,2] <- sum(R0datahh$thhage2[R0datahh$age<=1]+R0datahh$thhage3[R0datahh$age<=1]+R0datahh$thhage4[R0datahh$age<=1])
sahh[2,1] <- sum(R0datahh$thhage0[R0datahh$age>1]+R0datahh$thhage1[R0datahh$age>1])
sahh[2,2] <- sum(R0datahh$thhage2[R0datahh$age>1]+R0datahh$thhage3[R0datahh$age>1]+R0datahh$thhage4[R0datahh$age>1])

sa[1,1] <- sum(R0datahh$hhage0[R0datahh$age<=1]+R0datahh$hhage1[R0datahh$age<=1])
sa[1,2] <- sum(R0datahh$hhage2[R0datahh$age<=1]+R0datahh$hhage3[R0datahh$age<=1]+R0datahh$hhage4[R0datahh$age<=1])
sa[2,1] <- sum(R0datahh$hhage0[R0datahh$age>1]+R0datahh$hhage1[R0datahh$age>1])
sa[2,2] <- sum(R0datahh$hhage2[R0datahh$age>1]+R0datahh$hhage3[R0datahh$age>1]+R0datahh$hhage4[R0datahh$age>1])

kable(sa/sahh, digits=4, caption="Modeled household secondary infection attack rates for COVID-19. Age of index cases in rows, infectees in columns.")

addy91sar <- matrix(data=c(0.2897,0.1423,0.1031,0.1555),nrow=2,ncol=2, dimnames=list(c("child", "adult"),c("child", "adult")), byrow=TRUE)
kable(addy91sar, caption="Influenza household secondary infection attack rates from Addy et al 1991. Index cases in rows, infectees in columns. This is just here for comparison with model results for COVID-19.")
```

In Corvid, we can measure the household secondary attack rates by infecting a random individual in the population with a non-transmissible pathogen (as was used to compute R0) and count the number of infections in that person's household.
For R0=2.6, if an index case is a child, the household infection attack rate is `r round(100*(sa/sahh)[1,1],1)`% for children and `r round(100*(sa/sahh)[1,2],1)`% for adults.
If an index case is an adult, the household infection attack rate is `r round(100*(sa/sahh)[2,1],1)`% for children and `r round(100*(sa/sahh)[2,2],1)`% for adults.
If we assume a symptomatic fraction of about 50%,
then the symptomatic attack rate in Corvid is about `r round(0.5*100*(sa/sahh)[2,2],1)`% if the infecter and infectees are adults, which is close to the observed 15%.

\clearpage
## Effectiveness of school closures

```{r cases-schoolclosures-timing, fig.width=7, fig.height=8, fig.cap="Modeling school closures with different start dates and durations. The days when schools are closed are shown as horizontal lines near the x-axis, color-coded by duration of school closure. The left plots show numbers of newly symptomatic people per day per 100,000 population, and the right plots show cumulative % of the population symptomatic.", echo=FALSE}
r0 <- 2.6
denominator <- 100000 # scale results to standard pop size
palduration <- c("black","blue","orangered","seagreen","royalblue")
names(palduration) <- c("No intervention", "14", "42", "180")

par(mfrow=c(3,2),
    mar=c(3.3,3.3,2.5,1), #bottom, left, top, and right.
    mgp=c(2.35, 0.6, 0))
responsedays <- c(60,74,100)
for (responseday in responsedays) {
    for (plottype in c("symptomatic", "cumulative")) {
        xmax <- 200
        ymax <- ifelse(plottype=="cumulative", 42, 1150)
        y <- newlysymptomatic.seattle[[as.character(r0)]]*denominator/popsize.seattle
        if (plottype=="cumulative") {
            y <- 100*csymptomatic.seattle[[as.character(r0)]]/popsize.seattle
        }
        days <- 1:length(newlysymptomatic.seattle[[as.character(r0)]])
        plot(x=days, y=y, xlab="days since introduction", ylab=ifelse(plottype=="cumulative", "cumulative symptomatic, %", paste("daily new symptomatic /", as.integer(denominator))), main=paste(ifelse(plottype=="cumulative", "Cumulative symptomatic", "Newly symptomatic per day"), ", schools close on day ",responseday,sep=""), type="l", col="black", lwd=2, cex.main=1.1, cex.lab=1.1, xlim=c(1,xmax), ylim=c(ifelse(plottype=="cumulative",-4,-100),ymax), axes=FALSE)
        axis(1, at=c(seq(0,365,30),responseday), cex.axis=0.8)
        if (plottype=="cumulative") {
            axis(2, at=seq(0,100,10), lab=paste(seq(0,100,10), "%", sep=""), cex.axis=0.9, las=2)
        } else {
            axis(2, cex.axis=0.9)
        }    
        polygon(x=c(days,max(days), 0), y=c(y,0,0), col="gray92", lwd=0.2)
        symp <- list()
        csymp <- list()
        nsymp <- list()
        closureduration <- vector()
        durations <- c(14,42,180)
        for (i in 1:length(durations)) {
            duration <- durations[i]
            filename <- paste("../manuscript/results/Summary-seattle",r0*10,"-totalschoolclosure-",responseday,"-",duration,".txt",sep="")
            temp <- readLines(filename)
            symp[[as.character(duration)]] <- as.numeric(strsplit(gsub("^.*: ","",temp[grep("Number symptomatic", temp)]),",")[[1]])
            csymp[[as.character(duration)]] <- as.numeric(strsplit(gsub("^.*: ","",temp[grep("Cumulative symptomatic", temp)]),",")[[1]])
            nsymp[[as.character(duration)]] <- c(symp[[as.character(duration)]][1], diff(csymp[[as.character(duration)]]))
#        responseday[as.character(duration)] <- as.numeric(strsplit(gsub("^.*: ","",temp[grep("Reactive strategies deployed on day", temp)]),",")[[1]])
            closureduration[as.character(duration)] <- as.numeric(strsplit(gsub("^.*: ","",temp[grep("School closure days", temp)]),",")[[1]])
            if (plottype=="cumulative") {
                lines(x=1:length(csymp[[as.character(duration)]]), y=100*csymp[[as.character(duration)]]/popsize.seattle, col=palduration[as.character(duration)], lwd=2)
            } else {
                lines(x=1:length(nsymp[[as.character(duration)]]), y=nsymp[[as.character(duration)]]*denominator/popsize.seattle, col=palduration[as.character(duration)], lwd=2)
            }
            lines(x=responseday+c(0,duration), y=rep(-i*ifelse(plottype=="cumulative",1.1,33),2), col=palduration[as.character(duration)], lwd=4) # school closure dates
        }
        legend("topleft", legend=c("no closures", paste("closed ", durations, "days starting day", responseday)), fill=c(palduration), cex=0.7, inset=0.01, bg="white")
    }
}
```

```{r cases-schoolclosures-peak, fig.width=7, fig.height=6.5, fig.cap="Timing school closures to reduce the epidemic peak. School closures with different start dates and duration were simulated, shown in different colors. The days when schools are closed are shown as color-coded horizontal lines near the x-axis. The top left plot shows the number of newly symptomatic people per day per 100,000 population, and the top right shows cumulative % of the population symptomatic. The bottom plot is R_eff over time computed for every 15-day window. Dashed gray horizontal lines are at 2.6 (R_0) and 1.0. One stochastic run per scenario. Bottom right is the number of daily newly symptomatic adults (ages 30 years and older) per 100,000 older adults.", echo=FALSE}
# load the "no intervention" outputs
r0 <- 2.6
denominator <- 100000 # scale results to standard pop size
par(mfrow=c(2,2),
    mar=c(3.3,3.3,2.5,1), #bottom, left, top, and right.
    mgp=c(2.35, 0.6, 0))
palscenario <- c("black","purple","seagreen","orangered","royalblue")
filenames <- c("Summary-seattle26-1-school-all-365-llwfh-0-runlength240.txt",
               "Summary-seattle26-60-school-all-365-llwfh-0-runlength240.txt",
	       "Summary-seattle26-60-school-all-42-llwfh-0-runlength240.txt",
	       "Summary-seattle26-90-school-all-42-llwfh-0-runlength240.txt")
days <- 1:length(newlysymptomatic.seattle[[as.character(r0)]])
for (plottype in c("symptomatic", "cumulative")) {    
    ymax <- ifelse(plottype=="cumulative", 42, 1150)
    y <- newlysymptomatic.seattle[[as.character(r0)]]*denominator/popsize.seattle
    if (plottype=="cumulative") {
        y <- 100*csymptomatic.seattle[[as.character(r0)]]/popsize.seattle
    }
    plot(x=days, y=y, xlab="days since introduction", ylab=ifelse(plottype=="cumulative", "cumulative symptomatic, %", paste("symptomatic /", as.integer(denominator))), main=paste(ifelse(plottype=="cumulative", "Cumulative symptomatic", "Newly symptomatic per day"), ", R0=",r0,sep=""), type="l", col="black", lwd=2, cex.main=1.1, cex.lab=1.1, ylim=c(ifelse(plottype=="cumulative",-4,-100),ymax), axes=FALSE)
    axis(1, at=seq(0,365,30), cex.axis=0.8)
    if (plottype=="cumulative") {
        axis(2, at=seq(0,100,10), lab=paste(seq(0,100,10), "%", sep=""), cex.axis=0.9, las=2)
    } else {
        axis(2, cex.axis=0.9)
    }    
    polygon(x=c(days,max(days), 0), y=c(y,0,0), col="gray92", lwd=0.2)
    symp <- list()
    csymp <- list()
    nsymp <- list()
    responseday <- vector()
    closureduration <- vector()
    for (filenum in 1:length(filenames)) {
	scenario <- filenames[filenum]
        temp <- readLines(paste("../seattleschool/results/",filenames[filenum],sep=""))
        symp[[filenum]] <- as.numeric(strsplit(gsub("^.*: ","",temp[grep("Number symptomatic", temp)]),",")[[1]])
        csymp[[filenum]] <- as.numeric(strsplit(gsub("^.*: ","",temp[grep("Cumulative symptomatic", temp)]),",")[[1]])
        nsymp[[filenum]] <- c(symp[[filenum]][1], diff(csymp[[filenum]]))
        responseday[filenum] <- as.numeric(strsplit(gsub("^.*: ","",temp[grep("Reactive strategies deployed on day", temp)]),",")[[1]])
        closureduration[filenum] <- as.numeric(strsplit(gsub("^.*: ","",temp[grep("School closure days", temp)]),",")[[1]])
	if (plottype=="cumulative") {
            lines(x=1:length(csymp[[filenum]]), y=100*csymp[[filenum]]/popsize.seattle, col=palscenario[filenum+1], lwd=2)
	} else {
            lines(x=1:length(nsymp[[filenum]]), y=nsymp[[filenum]]*denominator/popsize.seattle, col=palscenario[filenum+1], lwd=2)
	}
        lines(x=responseday[filenum]+c(0,closureduration[filenum]), y=rep(-filenum*ifelse(plottype=="cumulative",1,30),2), col=palscenario[filenum+1], lwd=4) # school closure dates
    }
    if (plottype=="cumulative") {
        legend("topleft", legend=c("no closures", paste("closed ", closureduration, "days starting day", responseday)), fill=c(palscenario), cex=0.56, inset=0.01, bg="white")
    }
#    legend("topleft", legend=c("no closures", paste("closed ", closureduration, "days starting day", responseday)), fill=c(palscenario), cex=0.3749, inset=0.01, bg="white")
}

# R effective over time
r0 <- 2.6
filenames <- c("Individuals-seattle26.txt",
               "Individuals-seattle26-1-school-all-365-llwfh-0-runlength240.txt",
               "Individuals-seattle26-60-school-all-365-llwfh-0-runlength240.txt",
	       "Individuals-seattle26-60-school-all-42-llwfh-0-runlength240.txt",
	       "Individuals-seattle26-90-school-all-42-llwfh-0-runlength240.txt")
ymax <- 3.4
binsize <- 15
xmax <- 239
    plot(x=NA, y=NA, xlab="days since introduction", ylab="R_effective", main=paste("R_effective over time, R0=",r0,sep=""), type="l", col="black", lwd=2, cex.main=1.1, cex.lab=1.1, xlim=c(0,xmax), ylim=c(-0.5,ymax), axes=FALSE)
    axis(1, at=seq(15,365,30), cex.axis=1, lwd=0.9, tck=-0.02, col="darkgray", col.axis=NA)
    axis(1, at=seq(0,365,30), cex.axis=0.8)
    axis(2, cex.axis=1, las=2)
    abline(a=1,b=0,lty="dashed",col="darkgray")
    abline(a=r0,b=0,lty="dashed",col="darkgray")

    for (filenum in 1:length(filenames)) {
        individuals <- read.csv(paste("../seattleschool/results/",filenames[filenum],sep=""), header=TRUE)
	windowstarts <- seq(0,xmax,binsize) # start of window in days
	y <- sapply(windowstarts, function(windowstart) {
	    valid <- individuals$infectedtime/2>=windowstart & individuals$infectedtime/2<windowstart+binsize
	    sum(individuals$sourceid %in% individuals$id[valid])/sum(valid)
	    })
	points(x=windowstarts+binsize/2, y=y, pch=filenum, col=palscenario[filenum], lwd=1)
	lines(x=windowstarts+binsize/2, y=y, col=palscenario[filenum], lwd=3)
	if (filenum>1) {
          lines(x=responseday[filenum-1]+c(0,closureduration[filenum-1]), y=rep(-filenum*0.1,2), col=palscenario[filenum], lwd=4) # school closure dates
	}
    }
    legend("topright", legend=c("no closures", paste("closed ", closureduration, "days starting day", responseday)), col=c(palscenario), pch=1:length(filenames), lwd=1.5, cex=0.75, inset=0.01, bg="white")

# Symptomatic older adults over time
r0 <- 2.6
filenames <- c("Log-seattle26.txt",
               "Log-seattle26-1-school-all-365-llwfh-0-runlength240.txt",
               "Log-seattle26-60-school-all-365-llwfh-0-runlength240.txt",
	       "Log-seattle26-60-school-all-42-llwfh-0-runlength240.txt",
	       "Log-seattle26-90-school-all-42-llwfh-0-runlength240.txt")
symptomaticbydayandage <- list()
for (filenum in 1:length(filenames)) {
      logfile <- read.csv(paste("../seattleschool/results/",filenames[filenum],sep=""))
      cumsym <- matrix(NA, nrow=max(logfile$time)+1, ncol=5)
      for (day in 0:max(logfile$time)) {
          s <- colSums(logfile[logfile$time==day,])
          cumsym[day+1,] <- s[grep("cumsym",names(s))]
      }
      sym <- matrix(NA, nrow=max(logfile$time)+1, ncol=5)
      colnames(sym) <- names(s)[grep("cumsym",colnames(logfile))]
      colnames(sym) <- gsub(pattern="cum",replacement="",x=colnames(sym))
      sym[1,] <- cumsym[1,]
      for (i in 1:ncol(sym)) {
          sym[-1,i] <- diff(cumsym[,i])
      }
      symptomaticbydayandage[[filenum]] <- sym
}

popsize.seattle.older <- sum(tracts.seattle$pop30.64 +tracts.seattle$pop65.) # pop >=30y    
ymax <- 1000
plot(x=NA, y=NA, xlab="days since introduction", ylab="newly symptomatic / 100000, >=30y", main=paste("Newly symptomatatic adults per day", ", R0=",r0,sep=""), type="l", col="black", lwd=2, cex.main=1, cex.lab=1.01, xlim=c(0,240), ylim=c(-120,ymax), axes=FALSE)
axis(1, at=seq(0,365,30), cex.axis=0.8)
axis(2, at=seq(0,ymax,200), cex.axis=0.9)
for (filenum in 1:length(filenames)) {
  y <- (symptomaticbydayandage[[filenum]][,"sym30.64"] + symptomaticbydayandage[[filenum]][,"sym65."]) * denominator / popsize.seattle.older
  lines(1:length(y), y, col=palscenario[filenum], lwd=2)
  if (filenum>1) {
       lines(x=responseday[filenum-1]+c(0,closureduration[filenum-1]), y=rep(-filenum*30+20,2), col=palscenario[filenum], lwd=4) # school closure dates
  }
}
#legend("topright", legend=c("no closures", paste("closed ", closureduration, "days starting day", responseday)), col=c(palscenario), pch=1:length(filenames), lwd=1.5, cex=0.75, inset=0.01, bg="white")
```

## Modeling other non-pharmaceutical interventions

```{r cases-seattle-socialdistancing, fig.width=7, fig.height=3.25, fig.cap="Simulating school closures with other policies. The dashed vertical line is the start of social distancing policies on day 60. We test school closures alone, work from home/liberal leave (50% compliance) without school closures, and a combination of all three policies. The red bar near the x-axis marks the days when schools are closed (for 56 days). The other policies (liberal leave and working from home) continue indefinitely. On the left, daily new symptomatic cases per 100,000 population. On the right, cumulative % of the population that was symptomatic.", echo=FALSE}
duration <- 56
compliance <- 50
delay <- 0
r0 = 2.6

par(mfrow=c(1,2),
    mar=c(3.5,3.5,2,1), #bottom, left, top, and right.
    mgp=c(2.0, 0.6, 0))
denominator <- 100000
xmax <- 230
    triggerday <- list()
    closurelength <- list()
    symp <- list()
    csymp <- list()
    nsymp <- list()
    palsocialdistancing <- c("black","red","orange","blue")
    scenarios <- c("school closure only", "wfh/ll only", "school closure + wfh/ll")
    names(palsocialdistancing) <- c("no intervention",scenarios)
for (plottype in c("symptomatic", "cumulative")) {
    ymax <- ifelse(plottype=="cumulative", 42, 1100)
    days <- 1:length(newlysymptomatic.seattle[[as.character(r0)]])
    plot(x=NA, y=NA, xlab="days since introduction", ylab=ifelse(plottype=="cumulative","cumulative symptomatic, %",paste("newly symptomatic/",as.integer(denominator)," pop", sep="")), main="School closures and work-based policies", type="l", col="black", axes=FALSE, lwd=2, cex.main=0.8, cex.lab=0.85, ylim=c(-ymax/100,ymax), xlim=c(0,xmax))
    axis(2, cex.axis=0.8)
    axis(1, at=seq(0,xmax,30), cex.axis=0.8)
    y <- NA
    if (plottype=="cumulative") {
       y <- csymptomatic.seattle[[as.character(r0)]] * 100/popsize.seattle
    } else {
       y <- newlysymptomatic.seattle[[as.character(r0)]] * denominator/popsize.seattle
    }
    polygon(x=c(days,max(days), 0), y=c(y,0,0), col="gray92", lwd=0.5)

    for (scenario in scenarios) {
	filename <- "results/Summary-seattle26-combo-school"
	if (scenario=="wfh/ll only") {
	    filename <- "results/Summary-seattle26-combo-libleavewfh50"
	} else if (scenario=="school closure + wfh/ll") {
	    filename <- "results/Summary-seattle26-combo-school-libleavewfh50"
	}
        temp <- readLines(filename)
        triggerday[[scenario]] <- as.numeric(strsplit(gsub("^.*: ","",temp[grep("Reactive strategies deployed on day", temp)]),",")[[1]])
        closurelength[[scenario]] <- as.numeric(strsplit(gsub("^.*: ","",temp[grep("School closure days", temp)]),",")[[1]])
        symp[[scenario]] <- as.numeric(strsplit(gsub("^.*: ","",temp[grep("Number symptomatic", temp)]),",")[[1]])
        csymp[[scenario]] <- as.numeric(strsplit(gsub("^.*: ","",temp[grep("Cumulative symptomatic", temp)]),",")[[1]])
        nsymp[[scenario]] <- c(symp[[scenario]][1], diff(csymp[[scenario]]))
	days <- 1:length(nsymp[[scenario]])
        if (plottype=="cumulative") {
            y <- csymp[[scenario]]*100/popsize.seattle
	} else { 
	    y <- nsymp[[scenario]]*denominator/popsize.seattle
	}
        lines(x=days, y=y, col=palsocialdistancing[scenario], lwd=1.8)
        if (scenario=="school closure only") {
            lines(x=rep(delay+triggerday[[scenario]],2), y=c(-100,ymax+100), lty="dashed")
	    lines(x=delay+triggerday[[scenario]]+c(0,closurelength[[scenario]]), y=rep(-ymax/100,2), col=palsocialdistancing[scenario], lwd=2.5)
        } else if (scenario=="wfh/ll only") {
	    lines(x=delay+triggerday[[scenario]]+c(0,1000), y=rep(-ymax/35,2), col=palsocialdistancing[scenario], lwd=2.5)
        }
    }
    legend("topleft", legend=c("no intervention", scenarios), fill=c("black", palsocialdistancing[scenarios]), cex=0.54, inset=0.01, bg="white")
}
```

```{r cases-shutdown, fig.width=7, fig.height=8.5, fig.cap="Simulating a ``shutdown'' for 56 or 90 days. When a specified number of symptomatic cases is reached (0.001 or 0.0001 of the population), schools close, most people work from home, and interaction with other people is reduced by 75%. After 56 or 90 days, all schools and workplaces re-open. Each curve is one stochastic realization, 10 per panel. The red bars on the bottom indicate the shutdown dates, and the vertical lines are the starts of the shutdowns for each of the stochastic realizations. The reference curve in gray is a single run of an uninterrupted epidemic. R0=2.6.", echo=FALSE}
par(mfrow=c(4,2),
    mar=c(3.4,3.4,2,1), #bottom, left, top, and right.
    mgp=c(1.9, 0.6, 0))
r0 <- 2.6
denominator <- 100000
duration <- 56
communitycontactreduction <- 0.75
compliance <- 0.9
#for (compliance in c(0.75,0.9)) {
for (duration in c(56,90)) {
    for (threshold in c(0.001,0.0001)) {
        for (plottype in c("symptomatic", "cumulative")) {
            xmax <- 240
            ymax <- ifelse(plottype=="cumulative", 41, 1000)
            plot(x=NA, y=NA, xlim=c(0,length(newlysymptomatic.seattle[[as.character(r0)]])), ylim=c(-ymax*0.04,ymax), xlab="days since introduction", ylab=ifelse(plottype=="cumulative", "cumulative symptomatic, %", paste("newly symptomatic /", as.integer(denominator))), main=paste(
"Shutdown for ",duration," days, start threshold of ",format(threshold,scientific=FALSE), sep=""), cex.main=1.1, cex.lab=0.95, cex.axis=0.8, axes=FALSE) # compliance=",100*compliance,"%, community reduction=",100*communitycontactreduction,"%"
            axis(2, cex.axis=1.1)
            axis(1, at=seq(0,xmax,30), cex.axis=1.1)
	    # plot baseline run
            y <- newlysymptomatic.seattle[[as.character(r0)]]*denominator/popsize.seattle
            if (plottype == "cumulative") {
                y <- csymptomatic.seattle[[as.character(r0)]]*100/popsize.seattle
            }
            days <- 1:length(y)
            polygon(x=c(days,max(days), 0), y=c(y,0,0), col="gray92", lwd=1.2)
            if (plottype == "cumulative") {
                for (i in seq(0,ymax,10)) {
                    abline(i,0,lwd=0.5,col="gray85")
                }
            }

	    # plot intervention runs
            symptomatic <- list()
            csymptomatic <- list()
            newlysymptomatic <- list()
            responseday <- list()
            responseduration <- list()
            for (randomseed in c(1:10)) {
                filename <- paste("results/Summary-seattle",r0*10,"-shutdown-",duration,"-",format(threshold,scientific=FALSE),"-",compliance,"-",communitycontactreduction,"-",randomseed,sep="")
                temp <- readLines(filename)
                scenarioname <- filename
                symptomatic[[scenarioname]] <- as.numeric(strsplit(gsub("^.*: ","",temp[grep("Number symptomatic", temp)]),",")[[1]])
                csymptomatic[[scenarioname]] <- as.numeric(strsplit(gsub("^.*: ","",temp[grep("Cumulative symptomatic", temp)]),",")[[1]])
                newlysymptomatic[[scenarioname]] <- c(symptomatic[[scenarioname]][1], diff(csymptomatic[[scenarioname]]))
		responseday[[scenarioname]] <- as.numeric(strsplit(gsub("^.*: ","",temp[grep("Reactive strategies deployed on day", temp)]),",")[[1]])
		responseduration[[scenarioname]] <- as.numeric(strsplit(gsub("^.*: ","",temp[grep("School closure days", temp)]),",")[[1]])
                y <- newlysymptomatic[[scenarioname]]*denominator/popsize.seattle
                if (plottype == "cumulative") {
                    y <- csymptomatic[[scenarioname]]*100/popsize.seattle
                }
                lines(x=responseday[[scenarioname]] + c(0,responseduration[[scenarioname]]), y=rep(-randomseed*ymax*0.008,2), col="red", lwd=1) # duration of shutdown
#		text(x=responseday[[scenarioname]], y=ymax/10, lab="policies start", srt=90, col="salmon", cex=0.8, adj=c(0,-0.3))
                lines(x=rep(responseday[[scenarioname]],2), y=c(0,ymax*1.2), col="salmon", lwd=0.5, lty="dotted") # duration of shutdown
                lines(x=1:length(y), y=y, col="blue", lwd=1.2)
            }
#            legend("topleft", legend=policies, fill=palpolicies, bg="white", cex=0.55, inset=0.01)
	}
    }
}
```


```{r shutdown-trace, echo=FALSE}
summaryfile <- readLines("results/Summary-seattle26-shutdown-90-0.0001-0.9-0.75-8") # response starts on day 33
responseday <- as.numeric(strsplit(gsub("^.*: ","",summaryfile[grep("Reactive strategies deployed on day", summaryfile)]),",")[[1]])
responselength <- as.numeric(strsplit(gsub("^.*: ","",summaryfile[grep("School closure days", summaryfile)]),",")[[1]])

individuals <- read.csv("results/Individuals-seattle26-shutdown-90-0.0001-0.9-0.75-8", header=TRUE) # response starts on day 33
  individuals$SOURCETYPE <- as.factor(ifelse(individuals$sourcetype==0, NA,
                   ifelse(individuals$sourcetype==1, "daytime.family",
                   ifelse(individuals$sourcetype==2, "daytime.comm",
                   ifelse(individuals$sourcetype==3, "daytime.nh",
                   ifelse(individuals$sourcetype==4, "daytime.school",
                   ifelse(individuals$sourcetype==5, "daytime.work",
                   ifelse(individuals$sourcetype==10, "nighttime.family",
                   ifelse(individuals$sourcetype==11, "nighttime.comm",
                   ifelse(individuals$sourcetype==12, "nighttime.nh",
                   ifelse(individuals$sourcetype==13, "nighttime.hhcluster",
                   ifelse(individuals$sourcetype==20, "seeded",
		   ifelse(individuals$sourcetype==21, "airport", "error")))))))))))))
  individuals$generationtime <- (individuals$infectedtime-individuals$infectedtime[match(individuals$sourceid,individuals$id)])/2 # how many days ago was the infecter infected?
  individuals$generationtime[individuals$infectedtime<=0] <- NA # remove people never infected or infected on day 0
individuals$infectedday = individuals$infectedtime/2

# response starts on day 33. there were 49 symptomatic people on this day
temp <- data.frame(before.shutdown=as.vector(table(individuals$SOURCETYPE[individuals$infectedday<responseday])),
                   during.shutdown=as.vector(table(individuals$SOURCETYPE[individuals$infectedday>responseday & individuals$infectedday<responseday+responselength])))
rownames(temp) = levels(individuals$SOURCETYPE)
temp <- rbind(temp, total=colSums(temp))
kable(temp, caption="Proportion of cases by setting before and during a shutdown.")

# household R_effective
a <- (unique(individuals$id[individuals$infectedday>responseday & individuals$infectedday<responseday+65])) # people who were infected during the shutdown (up to day 65 of shutdown)
b <- (unique(individuals$familyid[individuals$infectedday>responseday & individuals$infectedday<responseday+65])) # households who were infected during the shutdown (up to day 65 of shutdown)
d <- (individuals$sourceid %in% a) & (individuals$infectedday<responseday+responselength) # who was infected by people in these households?
e <- (individuals$familyid != individuals$familyid[match(individuals$sourceid,individuals$id)]) # who were infected by people from outside their households? (households that "infect themselves" are knocked out)
f <- (individuals$familyid[d & e]) # households infected by people outside their households?
#length(unique(f))/length(unique(b)) # household R_effective
```

```{r shutdown-trace-graphviz, echo=FALSE}
# output file for graphviz
inplot <- ((individuals$infectedday>=0 & individuals$infectedday<responseday+responselength) | individuals$SOURCETYPE=="seeded")
lastcases <- (inplot & individuals$infectedday+21>responseday+responselength)
summary(individuals$infectedday>responseday & individuals$infectedday<responseday+responselength)

cat("digraph G{\n", file="shutdown.dot", append=FALSE)
cat(" size=\"10,3\"\n", file="shutdown.dot", append=TRUE)
cat(" margin=0\n", file="shutdown.dot", append=TRUE)

# first define styles for all the nodes
# make index cases different
cat(" node [style=filled, shape=box, color=purple, fontsize=30, fontname=Helvetica] {", file="shutdown.dot", append=TRUE)
cat(individuals$id[inplot & !lastcases & !is.na(individuals$SOURCETYPE) & individuals$SOURCETYPE=="seeded"], file="shutdown.dot", append=TRUE)
cat("}\n", file="shutdown.dot", append=TRUE)
cat(" node [fontsize=9, width=0.2, height=0.35, margin=0.03, fontname=Helvetica]\n", file="shutdown.dot", append=TRUE)
# school
cat(" node [style=filled, shape=ellipse, color=steelblue] {", file="shutdown.dot", append=TRUE)
cat(individuals$id[inplot & !lastcases & !is.na(individuals$SOURCETYPE) & individuals$SOURCETYPE=="daytime.school"], file="shutdown.dot", append=TRUE)
cat("}\n", file="shutdown.dot", append=TRUE)
# work
cat(" node [style=filled, shape=ellipse, color=springgreen] {", file="shutdown.dot", append=TRUE)
cat(individuals$id[inplot & !lastcases & !is.na(individuals$SOURCETYPE) & individuals$SOURCETYPE=="daytime.work"], file="shutdown.dot", append=TRUE)
cat("}\n", file="shutdown.dot", append=TRUE)
# family
cat(" node [style=filled, shape=ellipse, color=red] {", file="shutdown.dot", append=TRUE)
cat(individuals$id[inplot & !lastcases & !is.na(individuals$SOURCETYPE) & individuals$SOURCETYPE %in% c("daytime.family","nighttime.family")], file="shutdown.dot", append=TRUE)
cat("}\n", file="shutdown.dot", append=TRUE)
# community
cat(" node [style=filled, shape=ellipse, color=tan] {", file="shutdown.dot", append=TRUE)
cat(individuals$id[inplot & !lastcases & !is.na(individuals$SOURCETYPE) & individuals$SOURCETYPE %in% c("daytime.comm","daytime.nh","nighttime.nh","nighttime.comm","nighttime.hhcluster")], file="shutdown.dot", append=TRUE)
cat("}\n", file="shutdown.dot", append=TRUE)
# family, last cases
cat(" node [style=filled, shape=box, color=red, fontsize=30] {", file="shutdown.dot", append=TRUE)
cat(individuals$id[inplot & lastcases & !is.na(individuals$SOURCETYPE) & individuals$SOURCETYPE %in% c("daytime.family","nighttime.family")], file="shutdown.dot", append=TRUE)
cat("}\n", file="shutdown.dot", append=TRUE)
# community, last cases
cat(" node [style=filled, shape=box, color=tan, fontsize=30] {", file="shutdown.dot", append=TRUE)
cat(individuals$id[inplot & lastcases & !is.na(individuals$SOURCETYPE) & individuals$SOURCETYPE %in% c("daytime.comm","daytime.nh","nighttime.nh","nighttime.comm","nighttime.hhcluster")], file="shutdown.dot", append=TRUE)
cat("}\n", file="shutdown.dot", append=TRUE)

# output all the edges
for (i in which(inplot)) {
    if (!is.na(individuals$SOURCETYPE[i])) {
        if (individuals$id[i] != individuals$sourceid[i]) {
            cat(paste(" ",individuals$sourceid[i], " -> ", individuals$id[i], "\n", sep=""), file="shutdown.dot", append=TRUE)
        }
    }
}
cat("}\n", file="shutdown.dot", append=TRUE)

# run from the command line:
#dot -Tpdf shutdown.dot > tree-shutdown.pdf
#twopi -Tpdf shutdown.dot > radialtree-shutdown.pdf
```

During one stochastic realization of a 90-day shutdown with SARS-CoV-2 persistence, 
`r sum(individuals$infectedday>responseday & individuals$infectedday<responseday+responselength)` were infected during the shutdown.
When the shutdown started, there were `r sum(individuals$infectedday>0 & individuals$infectedday<responseday & individuals$infectedday>=responseday-21)` infected people,
`r sum(individuals$infectedday>0 & individuals$infectedday<responseday & individuals$incubationdays>0 & individuals$infectedday+individuals$incubationdays<responseday & individuals$infectedday>=responseday-21)` of whom were symptomatic.
On the last day of the shutdown, there were
`r sum(individuals$infectedday>0 & individuals$infectedday<responseday &
        individuals$infectedday>=responseday-21)` infected people,
of whom `r sum(individuals$infectedday>0 & individuals$infectedday<responseday &
        individuals$infectedday>=responseday-21 &
        individuals$incubationdays>0 &
        individuals$infectedday+individuals$incubationdays<responseday &
        individuals$infectedday+21>=responseday)` were symptomatic



To compute R_effective, we take the people infected during the first 65 days of the the shutdown (`r sum(individuals$sourceid %in% individuals$id[individuals$infectedday>responseday & individuals$infectedday<responseday+65])` people), 
and find that they infect `r sum(individuals$sourceid %in% individuals$id[individuals$infectedday>responseday & individuals$infectedday<responseday+65])` others, giving us an R_effective of 
`r round(sum(individuals$sourceid %in% individuals$id[individuals$infectedday>responseday & individuals$infectedday<responseday+65]) / sum(individuals$infectedday>responseday & individuals$infectedday<responseday+65),3)`.

For the "household" version of R_effective, we found people in `r length(unique(b))` households were infected during the first 65 days of the shutdown, and 
these people infected members of `r length(unique(f))` households,
meaning "household" R_effective was `r length(unique(f))/length(unique(b))`.

\clearpage

## Comparing different case isolation strategies

```{r cases-isolation-day90, fig.width=7, fig.height=6.5, fig.cap="Symptomatic people over time for three different test-and-isolate policies starting on day 90. We model 75% test coverage of symptomatic people and all ascertained individuals home-isolate upon ascertainment (symptom onset+delay) after the test centers open on day 90. We model home-isolation only (red), isolation + antivirals (green), and isolation + family home quarantine (purple). We assume perfect compliance with isolation and quarantine. Antivirals is near-perfect. On the left, newly symptomatic per day per 100,000 population. On the right, cumulative symptomatic people over time as % of population. No ascertainment delay. R0=2.6.", echo=FALSE}
testfractions = c(0.3,0.5,0.9)
paltestfraction <- c("black", "red", "seagreen", "royalblue", "orange")
names(paltestfraction) <- c(0, testfractions)
policies <- c("no intervention", "home isolate","isolate+antiviral","isolate+quarantine")
palpolicies <- c("black", "orangered", "darkgreen", "purple", "steelblue")
names(palpolicies) <- policies
r0 <- 2.6
denominator <- 100000
testdelay <- 0
par(mfrow=c(2,2),
    mar=c(3.4,3.4,2,1), #bottom, left, top, and right.
    mgp=c(1.9, 0.6, 0))
responseday <- 90
testfraction <- 0.75
for (responseday in c(90,30)) {
        for (plottype in c("symptomatic", "cumulative")) {
            xmax <- 240
            ymax <- ifelse(plottype=="cumulative", 41, 1000)
            plot(x=NA, y=NA, xlim=c(0,length(newlysymptomatic.seattle[[as.character(r0)]])), ylim=c(0,ymax), xlab="days since introduction", ylab=ifelse(plottype=="cumulative", "cumulative symptomatic, %", paste("newly symptomatic /", as.integer(denominator))), main=paste(ifelse(plottype=="cumulative", "Cumulative symptomatic", "Symptomatic per day"), ", testing starts on day ", responseday, sep=""), type="l", lwd=2, cex.main=0.9, cex.lab=1.0, axes=FALSE)
            axis(2, cex.axis=1.0)
            axis(1, at=seq(0,xmax,30), cex.axis=0.9)
            lines(x=rep(responseday,2), y=c(-100,ymax*1.2), lty="dashed", col="darkgray")
            text(x=responseday, y=ymax/10, lab="testing starts", srt=90, col="darkgray", cex=0.9, adj=c(0,-0.3))
            y <- newlysymptomatic.seattle[[as.character(r0)]]*denominator/popsize.seattle
            if (plottype == "cumulative") {
                y <- csymptomatic.seattle[[as.character(r0)]]*100/popsize.seattle
            }
            days <- 1:length(y)
            polygon(x=c(days,max(days), 0), y=c(y,0,0), col="gray92", lwd=1.5)
            if (plottype == "cumulative") {
                for (i in seq(0,ymax,10)) {
                    abline(i,0,lwd=0.5,col="gray85")
                }
            }
            for (policy in policies[-1]) {
                avpolicy <- ifelse(grepl("antiviral",policy), "treatmentonly", "none")
                quarantinepolicy <- ifelse(grepl("quarantine",policy), "1.0-14", "0-0")
                filename <- paste("results/Summary-seattle",r0*10,"-testandisolate-",testfraction,"-",testdelay,"-",responseday,"-",avpolicy,"-",quarantinepolicy,sep="")
                temp <- readLines(filename)
                scenarioname <- policy
                symptomatic.seattle[[scenarioname]] <- as.numeric(strsplit(gsub("^.*: ","",temp[grep("Number symptomatic", temp)]),",")[[1]])
                csymptomatic.seattle[[scenarioname]] <- as.numeric(strsplit(gsub("^.*: ","",temp[grep("Cumulative symptomatic", temp)]),",")[[1]])
                newlysymptomatic.seattle[[scenarioname]] <- c(symptomatic.seattle[[scenarioname]][1], diff(csymptomatic.seattle[[scenarioname]]))
                y <- newlysymptomatic.seattle[[scenarioname]]*denominator/popsize.seattle
                if (plottype == "cumulative") {
                    y <- csymptomatic.seattle[[scenarioname]]*100/popsize.seattle
                }
                lines(x=1:length(y), y=y, col=palpolicies[policy], lwd=2)
            }
            legend("topleft", legend=policies, fill=palpolicies, bg="white", cex=0.68, inset=0.01)
	}
}
```

We simulate home isolation, self-isolation (no transmission to family), and isolation+quarantine (family members can't go out).
Our preliminary results show that testing and home isolation alone do not greatly reduce the epidemic, but off-site isolation or home quarantine of family members may improve the strategy's effectiveness. If isolated people remain at home but family members do not, then this is probably bad due to high within-home transmission (over 30% household secondary attack rate in Corvid, depending on the age of the index case and household age structure, results are in a different document).
In the Chowell et al model, the isolated people are "treated" and not infectious at all.
To mimic the Chowell setup, we treated ascertained cases with an antiviral that was 100% effective, completely blocking transmission to family members.
By the time a case is ascertained, there is a reasonable chance that family members are infected, so quarantine of family members might be useful.

Because most infections in the model come from pre-symptomatic people or from infections that never show symptoms, it may be impossible to prevent more than 30% of infections with test-and-isolate unless you find a way to isolate non-symptomatic people (e.g., quarantine of families).


\clearpage
## King County

```{r load-king, echo=FALSE}
#library(rgdal) # for readOGR
library(rgdal)
#shapefile.washington <- readOGR("tract00.shp", verbose=FALSE)

#https://ofm.wa.gov/washington-data-research/population-demographics/gis-data/census-geographic-files

tractlocs.king <- read.csv("../corviddata/kingsnohomishpierce-tracts.dat", header=FALSE, col.names=c("fipsstate", "fipscounty", "fipstract", "population", "latitude", "longitude"))
tracts.king <- read.csv("../kingcounty/results/Tracts-bothell26-1.txt", header=TRUE)
tracts.king$pop <- rowSums(tracts.king[5:9])
tractlocs.king$TractID <- tracts.king$TractID[sapply(1:nrow(tractlocs.king), function(i) {which(tracts.king$FIPSstate==tractlocs.king$fipsstate[i] &
                tracts.king$FIPScounty==tractlocs.king$fipscounty[i] &
                tracts.king$FIPStract==tractlocs.king$fipstract[i])})]
```

We generated a synthetic population of King, Pierce, and Snohomish Counties (Washington State) based on 2000 Census data.
We run the model in a simulated population of `r as.integer(sum(tracts.king$pop))` residing in `r nrow(tracts.king)` census tracts.
Tracts have `r min(tracts.king$pop)` to `r as.integer(max(tracts.king$pop))` people living in them, and `r min(tracts.king$workers)` to `r as.integer(max(tracts.king$workers))` people working in them.
We ran the model starting with one infection in Bothell (on Snohomish side).
For reference, we call the start day "January 15 2020", even though the person was probably infected a couple of days earlier.
The first case was describe in Holshue et al 2020.
The epidemic does not always take off when only one person is infected.

```{r map-bothell-spread, fig.width=7, fig.height=8, fig.cap="Cumulative symptomatic infections after epidemic starts with one newly-infected person in Bothell on January 15. R_0=2.6. King County 2000 Census population used. Color is based on cumulative symptomatic attack rate. The location of the index case and IDM are plotted as circles for reference.", echo=FALSE}
daily.king <- read.csv("../kingcounty/results/Log-bothell26-2.txt", header=TRUE)
daily.king$CUMSYM <- rowSums(daily.king[,grep("cumsym",colnames(daily.king))])
startday <- as.Date("1-15-2020",format="%m-%d-%Y")
#pal <- c(heat.colors(30, rev=TRUE), rep("purple", 200))
pal <- c("gray92",
         colorRampPalette(c("salmon","orange"))(15),
         colorRampPalette(c("orange","red"))(12),
         colorRampPalette(c("red", "darkred"))(15),
         rep("black", 50))
par(mfrow=c(3,2),
    mar=c(0,0,2.5,0), #bottom, left, top, and right.
    mgp=c(0,0,0))
for (day in c(14,17+21,60,77,107,138)) {
    plot(x=tractlocs.king$longitude, y=tractlocs.king$latitude,
         main=paste((startday+day)," (day ", day, "), ", sum(daily.king$CUMSYM[daily.king$time==day]), " cases",sep=""),xlab="", ylab="",
         col=pal[1+ceiling(100*sapply(tractlocs.king$TractID, function(t) {daily.king$CUMSYM[daily.king$time==day & daily.king$TractID==t]})/tracts.king$pop)],
         cex=0.45, cex.main=1.2,
#  cex=0.01* (0.001+(100*sapply(tractlocs.king$TractID, function(t) {daily.king$CUMSYM[daily.king$time==day & daily.king$TractID==t]})/tracts.king$pop)),
         pch=19, lwd=0.1, asp=1, axes=FALSE)
    points(x=tractlocs.king$longitude[tractlocs.king$fipstract %in% c(51918,23500)], y=tractlocs.king$latitude[tractlocs.king$fipstract %in% c(51918,23500)], col="black", pch=1, cex=1.5, lwd=0.4) # Bothell and Eastgate
    legend("topleft", legend=paste(c(0,1,5,10,20,30,40),"%",sep=""), fill=pal[1+c(0,1,5,10,20,30,40)])
}
```

\clearpage
# Model overview

```{r map-seattle, fig.width=4, fig.height=4, fig.cap="Map of the census tracts for the synthetic Seattle population. Dot size proportional to resident population. Red circle size is proportional to the number of people who work in each tract.", echo=FALSE}
par(mar=c(3.5,3.5,1,1), #bottom, left, top, and right.
    mgp=c(2.0, 0.6, 0))
#pal <- heat.colors(max(tracts.seattle$pop)+1, rev=TRUE)
#plot(x=tractlocs.seattle$longitude, y=tractlocs.seattle$latitude, col=pal[tracts.seattle$pop[match(tractlocs.seattle$fipstract, tracts.seattle$FIPStract)]], cex=0.01*sqrt(tracts.seattle$pop[match(tractlocs.seattle$fipstract, tracts.seattle$FIPStract)]), pch=19, xlab="longitude", ylab="latitude", asp=1)
plot(x=tractlocs.seattle$longitude, y=tractlocs.seattle$latitude, col="blue", cex=0.01*sqrt(tracts.seattle$pop[match(tractlocs.seattle$fipstract, tracts.seattle$FIPStract)]), pch=19, xlab="longitude", ylab="latitude", asp=1, cex.axis=0.5, cex.lab=0.8)
points(x=tractlocs.seattle$longitude, y=tractlocs.seattle$latitude, col="red", cex=0.01*sqrt(tracts.seattle$workers[match(tractlocs.seattle$fipstract, tracts.seattle$FIPStract)]), pch=1)

if (FALSE) {
for (i in 1:nrow(wf.seattle)) {
  if (wf.seattle$flow[i]>100 & 
      wf.seattle$source.fipstract[i] %in% tracts.seattle$FIPStract[tracts.seattle$pop>8000]) {
    lines(x=tractlocs.seattle$longitude[match(c(wf.seattle$source.fipstract[i],wf.seattle$dest.fipstract[i]),tractlocs.seattle$fipstract)],
          y=tractlocs.seattle$latitude[match(c(wf.seattle$source.fipstract[i],wf.seattle$dest.fipstract[i]),tractlocs.seattle$fipstract)], col="red")
  }
}
}
```

## Calibration for SARS-CoV-2 transmission

### Symptomatic fraction, incubation period, shedding (infectiousness) kinetics

```{r incubation, fig.width=4.25, fig.height=3.25, fig.cap="Incubation period distribution and shedding trajectory in Corvid. Black curve is the log-normal distribution of incubation periods from Lauer et al, truncated at day 14. Incubation periods are drawn from this distribution in Corvid. The blue curve is shedding over time in Corvid, which is a log-normal distribution with a higher mean than but same sd as the incubation distribution. The distribution truncated at day 21. In Corvid, people start shedding the day after infection regardless of symptomatic status.", echo=FALSE}
par(mar=c(3.5,3.5,1,1), #bottom, left, top, and right.
    mgp=c(2.0, 0.6, 0))
time <- seq(0,14,0.1)
plot(x=time, y=dlnorm(time, meanlog=1.621, sdlog=0.418), xlim=c(0,21), type="l", lwd=1.5, xlab="days after infection", ylab="density", ylim=c(0,0.25), cex.lab=0.8, cex.axis=0.7) # from Lauer

days <- seq(1,14,1) 
cumulative <- plnorm(days, meanlog=1.621, sdlog=0.418)

time <- seq(0,21,0.1)
lines(x=time, y=dlnorm(time, meanlog=log(exp(1.621)+4), sdlog=0.418), col="blue")
legend("topright", legend=c("incubation period distribution","shedding trajectory"), col=c("black","blue"), lty=rep("solid",2), cex=0.8, inset=0.01)
```

### Estimating R_0


```{r r0calibration, fig.width=5.25, fig.height=4.25, fig.cap="Beta vs R0. The numbers represent the age bin of the index case (0..4).", echo=FALSE}
R0data <- read.csv("../r0runs/r0summary.csv")
R0data <- R0data[R0data$beta<=0.2,] # knock out high betas
agedist <- colSums(R0data[,6:10])
agedist <- agedist/sum(agedist)
par(mgp=c(1.8,0.5,0))
plot(0,0, pch=NA, xlim=c(0,max(R0data$beta)), ylim=c(0,7), xlab=expression(beta), ylab="secondary cases", cex.lab=1.0, cex.axis=1.0)
c <- rep(0,length(unique(R0data$beta)))
for (age in c(0:4)) {
  beta <- cases <- numeric()
  for (b in unique(R0data$beta)) {
    if (!is.na(b)) {
      beta <- append(beta, b)
      cases <- append(cases, mean(R0data$secondary[R0data$beta==b & R0data$age==age], na.rm=TRUE))
    }
  }
  points(beta, cases, pch=toString(age), col="blue", cex=0.5)
  c <- c+agedist[age+1]*cases
}
points(beta,c, cex=1, lwd=3, pch=3) # age weighted
lmf = summary(lm(c ~ beta, na.action = na.omit))
abline(lmf$coefficients[1],lmf$coefficients[2], col="gray20")
text(0,5.5,substitute(R[0] == a * beta + b, list(a=round(lmf$coefficients[2],digits=4), b=round(lmf$coefficients[1],digits=4))), pos=4, cex=1.0)
```

\clearpage
# Corvid implementation notes

Here are notes about the implementation of Corvid.

Removed parallel version of the model (differs from FluTE).
Can no longer close individual schools - must be the whole census tract.
Changed random number generator since the PLoS paper.
Used household data from PUMS (http://www2.census.gov/census_2000/datasets/PUMS/OnePercent/)
  For households of size 1-2, all combinations of ages were included.
  For households of size 3-7, only the household compositions that covered at least 1% of households of that size were used.
  So if there was an unusual structure (e.g., one elderly and several preschoolers), it was not included.
Changing case ascertainment code, since testing is coming online so late for coronavirus.

"Work from home" is a new intervention, in which a fraction of all employed adults stay home instead of going to work.
During the day, they have household contacts (if anyone is in the house) and contacts with people in their home community (because I assume they will leave their house).
